name: CI

on:
  push:
    branches-ignore:
      - "release-please*"

permissions: write-all

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created_sdk: ${{ steps.release.outputs['packages/sdk--release_created'] }}
      release_created_sdk_react_provider: ${{ steps.release.outputs['packages/sdk-react-provider--release_created'] }}
      release_created_developer: ${{ steps.release.outputs['apps/developer--release_created'] }}
      release_created: ${{ steps.release.outputs.release_created }}
      releases_created: ${{ steps.release.outputs.releases_created }}
      pr_created: ${{ steps.release.outputs.prs_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      tag_name_developer: ${{ steps.release.outputs['apps/developer--tag_name'] }}
      sha: ${{ steps.release.outputs.sha }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # target-branch: chore/my-please-release-testbranch

      - name: echo values
        run: |
          echo "Release created SDK: ${{ steps.release.outputs['packages/sdk--release_created']  }}"
          echo "Release created React Provider: ${{ steps.release.outputs['packages/sdk-react-provider--release_created'] }}"
          echo "Release created Developer: ${{ steps.release.outputs['apps/developer--release_created'] }}"
          echo "Releases created: ${{ steps.release.outputs.releases_created }}"
          echo "PR created: ${{ steps.release.outputs.prs_created }}"
          echo "Release tag_name: ${{ steps.release.outputs.tag_name }}"
          echo "Release tag_name Developer: ${{ steps.release.outputs['apps/developer--tag_name'] }}"
          echo "Release sha: ${{ steps.release.outputs.sha }}"
  build:
    env:
      CI: "true"

    needs: [release-please]
    name: Build, Test, Lint and Publish
    timeout-minutes: 15
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Cache PNPM install and Turbo
        uses: ./.github/actions/cache-setup

      - name: Build
        run: pnpm build

      - name: Upload static files as artifact
        continue-on-error: true
        id: docs-deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: apps/developer/build

      - name: Clean TypeDoc generated files and cache before rebuild
        continue-on-error: true
        run: rm -rf apps/developer/docs/packages apps/developer/.docusaurus

      - name: Build docs for embedding (baseUrl=/developers/)
        continue-on-error: true
        run: BASE_URL=/developers/ pnpm --filter developer build

      - name: Create docs tarball for docs release
        continue-on-error: true
        run: |
          cd apps/developer
          tar -czf developer-docs-build.tar.gz -C build .
          mv developer-docs-build.tar.gz ../../

      - name: Upload docs build to GitHub Release
        continue-on-error: true
        if: ${{ needs.release-please.outputs.release_created_developer == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          files: developer-docs-build.tar.gz
          tag_name: ${{ needs.release-please.outputs.tag_name_developer }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload docs to continuous 'docs-latest' release
        continue-on-error: true
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          files: developer-docs-build.tar.gz
          tag_name: docs-latest
          name: "Documentation Build (Latest)"
          body: |
            Latest documentation build from main branch.
            Built with `baseUrl='/developers/'` for embedding.

            **Download and extract:**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/docs-latest/developer-docs-build.tar.gz -o docs.tar.gz
            tar -xzf docs.tar.gz
            ```

            **Commit:** ${{ github.sha }}
            **Date:** ${{ github.event.head_commit.timestamp }}
          prerelease: false
          draft: false
          token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Deploy to GitHub Pages
      #   uses: peaceiris/actions-gh-pages@v4
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./apps/developer/build

      - name: Test
        run: pnpm test

      - name: Lint
        run: pnpm lint

      - name: Pre-Publish SDK
        run: pnpm --filter @monerium/sdk pub:pre
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
        if: needs.release-please.outputs.releases_created == 'false'

      - name: Pre-Publish React Provider
        run: pnpm --filter @monerium/sdk-react-provider pub:pre
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
        if: needs.release-please.outputs.releases_created == 'false'

      - name: Publish SDK
        run: pnpm --filter @monerium/sdk publish --access public
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
        if: ${{ needs.release-please.outputs.release_created_sdk }}

      - name: Publish React Provider
        run: pnpm --filter @monerium/sdk-react-provider publish --access public
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
        if: ${{ needs.release-please.outputs.release_created_sdk_react_provider }}
  deploy:
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    needs: [build, release-please]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to GitHub Pages
        id: docs-deployment
        uses: actions/deploy-pages@v4
